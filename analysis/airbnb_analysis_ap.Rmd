---
title: "Airbnb: Causal Inference"
subtitle: "Inferring Causal Effects of Marketing Ads on User Bookings"
author: "Andrew Pagtakhan"
date: "12/4/2020"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    number_section: true
---

R version 3.6.0 (2019-04-26)
Platform: x86_64-w64-mingw32

```{r setup, include=FALSE}
# installs packages if needed
if(!requireNamespace("arm"))
  install.packages("arm")
if(!requireNamespace("here"))
  install.packages("here")
if(!requireNamespace("tidyverse"))
  install.packages("tidyverse")
if(!requireNamespace("BART"))
  install.packages("BART")

# increase memory limit for matching function
#memory.limit(size = 4095)
```

```{r}
library(arm)
library(BART) # Bayesian Additive Regression Trees
library(here)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)

# set.seed(14)
```


# Load Data

```{r, message = FALSE}
# load bookings data
book <- read_csv(here("data", "bookings.csv"))
```

# Exploratory Data Analysis

## User demographics and overlap
See Tableau dashboard link below:

**https://public.tableau.com/profile/andrew.pagtakhan#!/vizhome/NYU_Causal_Airbnb/destination**

## Balance


# Modeling

## Propensity Scores

### Logistic Regression

```{r}
# see preliminary effects using logistic model
summary(lr <- glm(is_booked ~ age + gender + is_direct + 
                              first_device_type + browser_group, 
                  data = book, 
                  family = binomial(link = "logit")))

# get propensity scores
book$ps_lr <- predict(lr, type = "response")
tapply(book$ps_lr, book$is_booked, mean)
```

### BART

```{r}
# convert variables for BART model
book$gender <- as.factor(book$gender)
book$first_device_type <- as.factor(book$first_device_type)
book$browser_group <- as.factor(book$browser_group)
```

```{r, cache = TRUE}
# try BART on sample data first
# consider running analysis on sample of data only due to computational limits
book_sample <- sample_n(book, size = 100, replace = FALSE)
bart <- gbart(x.train = as.data.frame(book_sample %>% 
                                select(age, gender, first_device_type, 
                                       browser_group, is_direct)),  
              y.train = book_sample$is_booked,
              type = "lbart",
              seed = 14,
              mc.cores = 2)
# add prop scores to df
book_sample$ps_bart <- bart$prob.train.mean
```

```{r}
# define color palette for graphs
col.pal <- c("#999999", "#E69F00", "#56B4E9", "#777777")

# plot propensity scores
book_sample %>% 
  ggplot(aes(x = ps_bart, fill = as.factor(is_booked))) +
  geom_histogram(alpha = 0.5) + 
  labs(title = "Propensity Score Distribution: BART") + 
  theme(legend.position = "bottom") +
  scale_fill_manual(values = col.pal)
``` 


```{r, include=FALSE, eval=FALSE}
# run linear regression as sniff test
summary(lm(is_booked ~ age + gender + is_direct + 
                              first_device_type + browser_group, 
                  data = book))
```


### Matching
```{r, cache = TRUE}
# matching
matched_lr <- matching(z = book$is_direct, 
                       score = book$ps_lr, 
                       replace = TRUE)$cnts
```


### Balance
```{r}
bal_lr <- balance(book, 
                  treat = book$is_mkt, 
                  matched = matched_lr, 
                  estimand = "ATT")
```



### CART
Classification and Regression Trees


### BART
Bayesian Additive Regression Trees

# Matching

## 1-1 Matching

## Inverse Probability Treatment Weighting

# Causal Effect Estimation