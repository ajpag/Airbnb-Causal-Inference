---
title: "Airbnb: Causal Inference"
subtitle: "Inferring Causal Effects of Marketing Ads on User Bookings"
author: "Andrew Pagtakhan"
date: "12/4/2020"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    number_section: true
---

R version 3.6.0 (2019-04-26)
Platform: x86_64-w64-mingw32

```{r setup, include=FALSE}
# installs packages if needed
if(!requireNamespace("arm"))
  install.packages("arm")
if(!requireNamespace("here"))
  install.packages("here")
if(!requireNamespace("tidyverse"))
  install.packages("tidyverse")
if(!requireNamespace("BART"))
  install.packages("BART")
if(!requireNamespace("broom"))
  install.packages("broom")

# increase memory limit for matching functions
# make sure this limit is compatible with the system used to run this code
memory.limit(3.2e10)
```

```{r, warning = FALSE, message = FALSE}
library(arm)
library(BART) # Bayesian Additive Regression Trees
library(broom)
library(here)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, tidy.opts=list(width.cutoff=60), tidy=TRUE)
seed <- 14
set.seed(seed)
```


# Load Data

```{r, message = FALSE}
# load bookings data
book <- read_csv(here("data", "bookings_sample.csv"))
```


# Exploratory Data Analysis

## User demographics and overlap
See Tableau dashboard link below:

**https://public.tableau.com/profile/andrew.pagtakhan#!/vizhome/NYU_Causal_Airbnb/destination**

## Balance

# Modeling

## Logistic Regression

```{r}
# see preliminary effects using logistic model
summary(lr <- glm(is_booked ~ age + gender + treat + 
                              is_mobile + browser_group + is_eng, 
                  data = book, 
                  family = binomial(link = "logit")))

# get propensity scores
book$ps_lr <- predict(lr, type = "response")
tapply(book$ps_lr, book$is_booked, mean)
```


```{r}
# define color palette for graphs
col.pal <- c("#999999", "#E69F00", "#56B4E9", "#777777")

# plot propensity scores
book %>% 
  ggplot(aes(x = ps_lr, fill = as.factor(is_booked))) +
  geom_histogram(alpha = 0.5) + 
  labs(title = "Propensity Score Distribution: Logistic Regression") + 
  theme(legend.position = "bottom") +
  scale_fill_manual(values = col.pal)
```


## BART

```{r}
# convert variables for BART model
book$gender <- as.factor(book$gender)
book$first_device_type <- as.factor(book$first_device_type)
book$browser_group <- as.factor(book$browser_group)
```

```{r, cache = TRUE}
# run BART on sample data due to computational time
bart_sample <- 1000
book_sample <- sample_n(book, bart_sample)
# get covariates for model
xtrain_bart <- as.data.frame(book_sample %>% 
                               select(age, gender, treat, is_mobile, 
                                      browser_group, is_eng))
# run predictions on all data
xtest_bart <- as.data.frame(book %>% 
                                select(age, gender, treat, is_mobile, 
                                      browser_group, is_eng))

# fit and predict
bart <- gbart(x.train = xtrain_bart,  
              y.train = book_sample$is_booked,
              x.test = xtest_bart,
              type = "lbart",
              seed = seed,
              mc.cores = 2)

# add prop scores on full dataset
book$ps_bart <- bart$prob.test.mean
```


```{r, message=FALSE}
# define color palette for graphs
col.pal <- c("#999999", "#E69F00", "#56B4E9", "#777777")

# average propensity scores for plot
bart_prop <- book %>% 
             group_by(treat) %>% 
             summarise(avg = mean(ps_bart))

# plot propensity scores
book %>% 
  ggplot(aes(x = ps_bart, fill = as.factor(treat))) +
  geom_histogram(alpha = 0.5) + 
  geom_vline(data = bart_prop, aes(xintercept = avg, 
                                   colour = as.factor(treat))) +
  labs(title = "Propensity Score Distribution: BART",
       subtitle = "Vertical Lines: Average propensity scores") + 
  theme(legend.position = "bottom") +
  scale_fill_manual(values = col.pal) + 
  scale_color_manual(values = col.pal)
``` 


### Matching
```{r, cache = TRUE}
# 1-1 neighbor matching
matched_bart <- matching(z = book$treat, 
                         score = book$ps_bart, 
                         replace = TRUE)$cnts
# add matched counts to df
book$matched_bart <- matched_bart
```

```{r}
# inspect top 10 records used for matching
book %>% 
  arrange(desc(matched_bart)) %>% 
  select(age, gender, is_mobile, browser_group, is_eng, matched_bart) %>% 
  top_n(10, matched_bart)
```

### Balance

```{r}
# one hot encode categorical variables
one_hot_enc <- function(df) {
  # to be updated: add parameter to choose columns to convert (and retain as is)
  df_fin <- df %>% 
              rownames_to_column() %>% 
              pivot_longer(cols = c(gender, browser_group)) %>% 
              add_column(count = 1) %>% 
              arrange(value) %>% 
              pivot_wider(id_cols = c(rowname, age, is_mobile, is_eng, 
                                      treat, matched_bart, is_booked), 
                          names_from = value, 
                          values_from = count, 
                          values_fill = list(count = 0), 
                          values_fn = list(count = mean)) %>% 
              arrange(as.integer(rowname)) %>% 
              select(-rowname)
  return(df_fin)
}
```

```{r}
# one-hot encoding for balance metrics
book_bal <- one_hot_enc(book)
# compute balance statistics
bal_bart <- balance(as.matrix(book_bal %>% select(-c(matched_bart, treat))), 
                    treat = as.matrix(book_bal$treat), 
                    matched = as.matrix(book_bal$matched_bart), 
                    estimand = "ATT")

# plot balance
plot(bal_bart)
```

#### Inverse Probability Treatment Weighting (IPTW)

Generate IPTW

```{r}
# Apply Inverse Probability Treatment Weighting (IPTW)
# use the prop scores from BART model

# number of control vars
cnt0_bart <- nrow(filter(book, treat == 0))

# raw IPTW
book$weight_ip_bart <- if_else(book$treat == 0, 
                       book$ps_bart / (1 - book$ps_bart), 
                       1)

# normalize weights such that sum of weights for control = number of observed controls
weight_ip_sum_bart <- filter(book, treat == 0) %>% summarise(sum(weight_ip_bart))
book$weight_ip_bart_n <- if_else(book$treat == 0, 
                                 book$weight_ip_bart / weight_ip_sum_bart[[1]] * cnt0_bart,
                        1)
# consider capping weights
```

Balance statistics
```{r}
# compute balance statistics
bal_bart_iptw <- balance(as.matrix(book_bal %>% select(-c(matched_bart, treat))), 
                    treat = as.matrix(book_bal$treat), 
                    matched = as.matrix(book$weight_ip_bart_n), 
                    estimand = "ATT")

# plot balance
plot(bal_bart_iptw)
```

```{r}
# balance statistics
bal_bart$diff.means.matched
bal_bart_iptw$diff.means.matched
```


### Estimate Causal Effects

```{r}
# run initial logistic regression on restructured data (BART IPTW)
summary(lr_bart_iptw <- glm(is_booked ~ age + gender + treat + 
                              is_mobile + browser_group + is_eng, 
                  data = book, 
                  family = quasibinomial(link = "logit"),
                  weights = book$weight_ip_bart_n))
```


## CART
Classification and Regression Trees


# Causal Effect Estimation